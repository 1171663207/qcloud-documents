本文主要围绕我的页面 my 和 [云函数](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html) 进行讲解，更多代码细节可参见 [my 页面](https://github.com/ZiTao-Liu/Canteen-management-system/tree/main/miniprogram/pages/my)。




## 操作步骤
### 步骤1：获取 openid

1. 右击**当前环境**文件夹，单击**新建 Node.js 云函数**，并将文件命名为 **open**。
![](https://qcloudimg.tencent-cloud.cn/raw/fbc2d81502e939b58d4f9d423a139fce.png)
2. 在open云函数下，index.js文件下编写获取 openid 的代码。
<dx-codeblock>
:::  js
   // 云函数入口文件
   const cloud = require('wx-server-sdk')
   
   cloud.init()
   
   // 云函数入口函数
   exports.main = async (event, context) => {
       const wxContext = cloud.getWXContext()
   
       return {
           event,
           openid: wxContext.OPENID,
           appid: wxContext.APPID,
           unionid: wxContext.UNIONID,
       }
   }
:::
</dx-codeblock>
>? 从小程序端调用云函数时，开发者可以在云函数内使用 [`wx-server-sdk`](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/wx-server-sdk.html) 提供的 [`getWXContext`](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/utils/Cloud.getWXContext.html) 方法获取到每次调用的上下文（`appid`、`openid` 等），无需维护复杂的鉴权机制，即可获取天然可信任的用户登录态（`openid`）。
3. 然后右击 open 文件夹，单击**上传并部署：云端安装依赖**，即完成了云函数的编写。
![](https://qcloudimg.tencent-cloud.cn/raw/42162813a155c6eb9eabdf52cae913ee.png)
4. 进入 app.js 初始化云开发。
<dx-codeblock>
:::  js
// app.js
App({
  onLaunch: function () {
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力');
    } else {
      wx.cloud.init({
        // env 参数说明：
        //   env 参数决定接下来小程序发起的云开发调用（wx.cloud.xxx）会默认请求到哪个云环境的资源
        //   此处请填入环境 ID, 环境 ID 可打开云控制台查看
        //   如不填则使用默认环境（第一个创建的环境）
         env: '环境ID',
        traceUser: true,
      });
    }

    this.globalData = {};
  },
  globalData:{
    userid:'' 
  }
});
:::
</dx-codeblock>
5. 进入 my.js 在页面编写我的页面代码。在这里我们写一个点击事件，在用户点击我们绑定 getUserInfo 事件的按钮之后，我们调用获取用户信息。getopenid 是通过云函数获取用户 openid 方法。并将这个值存在 app.js 里面这样我们在其他页面可以直接进行调用。
<dx-codeblock>
:::  js
   const app = getApp();
   Page({
       /**
        * 页面的初始数据
        */
       data: {
           username:"",
           openid: '',
       },
       /**
        * 生命周期函数--监听页面加载
        */
       onLoad: function (options) {
        
       },
       getUserInfo(e){
           console.log(e);
           this.setData({
             username:e.detail.userInfo.nickName 
         })
         },
         getopenid(){
           var that=this;
           wx.cloud.callFunction({
             name: 'open',
             success:(res)=> {
               var usid = res.result.openid
               console.log(usid)
               this.setData({
                 openid:res.result.openid,
               })
               getApp().globalData. userid=res.result.openid
             },
             fail(res) {
               console.log("获取失败", res);
             }
           })
         },
      })
:::
</dx-codeblock>
6. 进入 my.wxml 页面，添加判断登录状态代码，我们可以进行判断如果没有获取到提醒用户登录，如果获取到的 openid 为空我们显示授权登录板块。
<dx-codeblock>
:::  xml
 <view class="topbanner"  wx:if="{{openid!=''}}"> 
		 <view class="toplogo">
				 <open-data type="userAvatarUrl"></open-data>
		 </view>
		 <view class="toptext">
		 <open-data type="userNickName" lang="zh_CN" class="user-name"></open-data>  
		 <view class="user-name2">爱国、敬业、求实、创新</view>
		 </view>
 </view>
 <view class="topbanner" wx:if="{{openid==''}}"> 
		 <view class="topban1">您还未授权登录</view>
		 <view class="topban1">去授权登录</view>
		 <button bindtap="getopenid" type="default">登录</button>
 </view>
:::
</dx-codeblock>


   
   这里我们可以思考一下，现在我们是不是每次用户进入小程序都需要用户授权登录一次呢，这样是不是不是很方便，我们可以将它存在 wx.setStorageSync，直接调用。
   
   > 将数据存储在本地缓存中指定的 key 中。会覆盖掉原来该 key 对应的内容。除非用户主动删除或因存储空间原因被系统清理，否则数据都一直可用。单个 key 允许存储的最大数据长度为 1MB，所有数据存储上限为 10MB
   
   ![](17.jpg)
   
### 步骤2：获取用户信息
   
   但我们要注意微信在2月21日之后open-data将无法展示用户个人信息，这里我们提供两种解决方案获取用户的信息：
   
   <img src="0.jpg" style="zoom:50%;" />
   
   ##### 第一种使用 getUserProfile
   
   我们可以查看一下官方文档 wx.getUserProfile(Object object)，获取用户信息。页面产生点击事件（例如 button 上 bindtap 的回调中）后才可调用，每次请求都会弹出授权窗口，用户同意后返回 userInfo。但要注意每次都需要授权一次是不是很麻烦，我们可以将他保存在我们数据库中授权一次日后直接调用。
   
   ###### 代码示例
   
   ```xml
   <view class="container">
     <view class="userinfo">
       <block wx:if="{{!hasUserInfo}}">
         <button wx:if="{{canIUseGetUserProfile}}" bindtap="getUserProfile"> 获取头像昵称 </button>
         <button wx:else open-type="getUserInfo" bindgetuserinfo="getUserInfo"> 获取头像昵称 </button>
       </block>
       <block wx:else>
         <image bindtap="bindViewTap" class="userinfo-avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
         <text class="userinfo-nickname">{{userInfo.nickName}}</text>
       </block>
     </view>
   </view>
   ```
   
   ```js
   Page({
     data: {
       userInfo: {},
       hasUserInfo: false,
       canIUseGetUserProfile: false,
     },
     onLoad() {
       if (wx.getUserProfile) {
         this.setData({
           canIUseGetUserProfile: true
         })
       }
     },
     getUserProfile(e) {
       wx.getUserProfile({
         desc: '用于完善会员资料', // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
         success: (res) => {
           this.setData({
             userInfo: res.userInfo,
             hasUserInfo: true
           })
         }
       })
     },
   ```
   
   #### 第二种使用 头像昵称填写
   
   当小程序需要让用户完善个人资料时，可以通过微信提供的头像昵称填写能力快速完善。
   
    **头像选择**
   
   需要将 button 组件 open-type 的值设置为 chooseAvatar，当用户选择需要使用的头像之后，可以通过 bindchooseavatar 事件回调获取到获取到头像信息的临时路径。
   
   **昵称填写**
   
   需要将 input 组件 type 的值设置为 nickname，当用户在此input进行输入时，键盘上方会展示微信昵称。
   
     然后我们将他存到数据库，日后直接调用即可！
   
   接下来我们开发攻略页面
   
   ```xml
   <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
     <image class="avatar" src="{{avatarUrl}}"></image>
   </button> 
   <input type="nickname" class="weui-input" placeholder="请输入昵称"/>
   ```
   
   ```js
   const defaultAvatarUrl = 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'
   Page({
     data: {
       avatarUrl: defaultAvatarUrl,
     },
     onChooseAvatar(e) {
       const { avatarUrl } = e.detail 
       this.setData({
         avatarUrl,
       })
     }
   })
   ```
   
   ![](51.jpg)
   
   接下来我们要将值进行存储，并上传数据库。我们使用form将数据保存到data里面。
   
   ```xml
   <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
     <image class="avatar" src="{{avatarUrl}}"></image>
   </button>
   <form catchsubmit="formSubmit">
     <view class="row">
       <view class="text1">名称：</view>
       <input type="nickname" class="weui-input" name="input" placeholder="请输入昵称" />
     </view>
     <button type="primary" style="margin-top:40rpx;margin-bottom:20rpx" formType="submit">提交</button>
   </form>
   ```
   
   ```js
   const defaultAvatarUrl = 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'
   Page({
     /**
      * 页面的初始数据
      */
     data: {
       avatarUrl: defaultAvatarUrl,
       name: '',
     },
     onChooseAvatar(e) {
       const { avatarUrl } = e.detail
       this.setData({
         avatarUrl,
       })
     },
     formSubmit(e) {
       console.log(e.detail.value.input)
       this.setData({
         name: e.detail.value.input
       })
      }
    })
   ```
   
   这样我们点击提交时候发现值保存data里面了，接下来我们获取openid,可以参考之前视频哦！这里默认已经将openid保存到app.js里面了！
   
   ```js
   onLoad: function (options) {
       const app = getApp()
       var userid = app.globalData.openid
       this.setData({
         userid: userid,
       })
     },
   ```
   
   接下来我们上传图片到云开发，然后存到数据库中，这里在cms创建内容模型。
   
   ![](48.jpg)
   
   这里我们使用到wx.cloud.uploadFile，将本地资源上传至云存储空间
   
   > 如果上传至同一路径则是覆盖写
   >
   > | 字段      | 说明                                                         | 数据类型 | 默认值 | 必填 |
   > | :-------- | :----------------------------------------------------------- | :------- | :----- | :--- |
   > | cloudPath | 云存储路径，命名限制见[文件名命名限制](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/storage/naming.html) | String   | -      | Y    |
   > | filePath  | 要上传文件资源的路径                                         | String   | -      | Y    |
   > | config    | 配置                                                         | Object   | -      | N    |
   > | success   | 成功回调                                                     |          |        |      |
   > | fail      | 失败回调                                                     |          |        |      |
   > | complete  | 结束回调                                                     |          |        |      |
   >
   > success 返回参数
   >
   > | 字段       | 说明                         | 数据类型 |
   > | :--------- | :--------------------------- | :------- |
   > | fileID     | 文件 ID                      | String   |
   > | statusCode | 服务器返回的 HTTP 状态码     | Number   |
   > | errMsg     | 错误信息，格式 uploadFile:ok | String   |
   
   ```js
   // pages/getuser/getuser.js
   const db = wx.cloud.database()
   const defaultAvatarUrl = 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'
   Page({
     /**
      * 页面的初始数据
      */
     data: {
       avatarUrl: defaultAvatarUrl,
       name: '',
       userid: '',
       userphoto: '',
       imgrl: ''
     },
     onChooseAvatar(e) {
       const { avatarUrl } = e.detail
       this.setData({
         avatarUrl,
       })
     },
     formSubmit(e) {
       console.log(e.detail.value.input)
       this.setData({
         name: e.detail.value.input
       })
       var that = this;
           wx.cloud.uploadFile({
             cloudPath: (new Date()).valueOf() + '.png', // 文件名
             filePath: this.data.avatarUrl, // 文件路径
             success: res => {
               // get resource ID
               console.log(res.fileID)
               // 赋值图片
               that.setData({
                 imgrl: res.fileID
               })
               that.upload(res.fileID);
             },
             fail: err => {
               // handle error
             }
           })
     },
     upload(filepath){
       console.log(filepath)
       db.collection("user").add({
         data: {
             name:this.data.name,
             openid:this.data.userid,
             userphoto:filepath,
             _createTime: Date.parse(new Date()),
         }
     }).then(res => {
         wx.showToast({
             title: '添加成功',
             icon: 'success',
             duration: 2000
         })
     })
     },
     /** 
      * 生命周期函数--监听页面加载
      */
     onLoad: function (options) {
       const app = getApp()
       var userid = app.globalData.openid
       this.setData({
         userid: userid,
       })
     },
   })
   ```
   
   这样我们就完成了！
   
   ![](c5.png)
