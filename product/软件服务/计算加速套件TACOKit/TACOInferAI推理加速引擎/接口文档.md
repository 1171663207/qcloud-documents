

## 优化接口

Taco 为您提供了一套简单易用的模型优化接口。对于 CPU 计算设备，优化接口为 `optimize_cpu`。代码如下：

```python
def optimize_cpu(
    input_model: Union[str, torch.nn.Module],
    output_model_dir: str,
    test_data: Optional[Dict[str, np.array]] = None,
    optimize_config: OptimizeConfig = OptimizeConfig(),
    model_config: ModelConfig = ModelConfig(),
) -> Dict:
```

参数说明如下：
<table>
<tr>
<th>参数</th>
<th>是否必填</th>
<th>说明</th>
</tr>
<tr>
<td>input_model</td>
<td>必填</td>
<td>待优化的模型。对于 TensorFlow，该参数为模型文件所在路径。TACO Infer 支持 TensorFlow frozen pb 和 saved model 两种模型格式。</td>
</tr>
<tr>
<td>output_model_dir</td>
<td>必填</td>
<td>优化后模型的保存目录。</td>
</tr>
<tr>
<td>test_data</td>
<td>可选</td>
<td>优化过程中需要使用到的模型输入的测试数据。TACO Infer 在优化模型的过程中需要使用测试数据对模型的性能，精度等指标进行评估，以指导模型优化过程。对于 TF 模型，该参数为 session run 所需的  feed_dict。<b>需注意，test_data 只接受 numpy array 数据格式。</b><br>构建 test_data 的方式示例如下：
<pre style="color:white">
import numpy as np

def gen_test_data(batch_size = 1):
    INPUT_NAME = "input:0"
    image_size = 299
    input_data = np.random.rand(batch_size, image_size, image_size, 3)
    return {INPUT_NAME: input_data}
</pre>
</td>
</tr>
<tr>
<td>optimize_config</td>
<td>可选</td>
<td>优化配置。您可以通过它指导 TACO Infer 提供更高质量的优化：
<ul style="margin-bottom:0px">
<li>通过 <code>print(optimize_config)</code> 可以查看默认（或修改后的）配置。</li>
<li>通过 <code>print(optimize_cfg.help())</code> 了解有哪些可配置项及如何配置。</li>
</ul>
</td>
</tr>
<tr>
<td>model_config</td>
<td>可选</td>
<td>模型配置。例如，对于存在1个以上 signature 的 TF SavedModel，您可以通过配置 <code>model_config</code> 知会 TACO Infer 哪一个需要被优化：
<ul style="margin-bottom:0px">
<li>通过 <code>print(model_config)</code>可以查看默认（或修改后的）配置。</li>
<li>通过 <code>print(model_cfg.help())</code> 了解有哪些可配置项及如何配置。示例如下：
<pre style="color:white">
print(model_cfg.help())

How-to-assign-a-"model_config":
tensorflow.inputs:
type: <class 'list'>, default value: None
Input tensor names as a list. Items may use node name as prefix, such as 
"Placeholder:0", or saved model signature.

tensorflow.outputs:
type: <class 'list'>, default value: None
Output tensor names as a list.

tensorflow.saved_model.signature:
type: <class 'str'>, default value: None
Tell TACO Inf which signature to use if more than 1 signature.

Example of updating a config:
model_config.parse({"tensorflow.inputs": ['Placeholder:0']})
<pre>
</li>
</ul>
</td>
</tr>
</table>


## Config 使用方式

`OptimizeConfig` 和 `ModelConfig` 使用方法是一致的。均支持通过 `parse` 接口设置相关属性的值，通过 "`.`" 获取属性值或者赋值。Config 使用示例如下所示：

```python
from taco import ModelConfig


cfg = ModelConfig()

# assign by parse()
cfg.parse({"tensorflow.inputs": ['Placeholder:0']})

print(cfg.tensorflow.inputs)

# assign by .
cfg.tensorflow.saved_model.signature = "predictions"

print(cfg.tensorflow.saved_model.signature)
```
