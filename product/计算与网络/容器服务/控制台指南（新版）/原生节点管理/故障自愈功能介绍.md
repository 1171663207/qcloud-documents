## 功能概览

基础设施的不稳定性、环境的不确定性常常会引发不同纬度的系统故障。为了将工作人员从繁重的运维事务中解放出来，腾讯云容器服务团队自研故障自愈功能来帮助运维人员快速定位问题，并通过预置平台运维经验，针对不同检测项提供最小化的自愈动作。该能力在NPD Plus组件的基础上进一步扩展，具体包含如下特性：
- 系统实时检测需要人为干预解决的持续性故障；
- 故障范围涵盖操作系统、k8s环境、运行时等数十种检测项；
- 通过预置专家经验（执行修复脚本、重启组件）来对故障进行快速响应；

## 检测项介绍


| **检测项**            | **描述**                                                     | **风险等级** | **自愈动作**   |
| --------------------- | ------------------------------------------------------------ | ------------ | -------------- |
| FDPressure            | Too many files opened(查看主机的文件描述符数量是否达到最大值的90%) | low          | 功能准备中...  |
| RuntimeUnhealthy      | List containerd task failed                                  | low          | RestartRuntime |
| KubeletUnhealthy      | Call kubelet healthz failed                                  | low          | RestartKubelet |
| ReadonlyFilesystem    | Filesystem is readonly                                       | high         | 功能准备中...  |
| OOMKilling            | Process has been oom-killed                                  | high         | 功能准备中...  |
| TaskHung              | Task blocked more then beyond the threshold                  | high         | 功能准备中...  |
| UnregisterNetDevice   | Net device unregister                                        | high         | 功能准备中...  |
| KernelOopsDivideError | Kernel oops with divide error                                | high         | 功能准备中...  |
| KernelOopsNULLPointer | Kernel oops with NULL pointer                                | high         | 功能准备中...  |
| Ext4Error             | Ext4 filesystem error                                        | high         | 功能准备中...  |
| Ext4Warning           | Ext4 filesystem warning                                      | high         | 功能准备中...  |
| IOError               | IOError                                                      | high         | 功能准备中...  |
| MemoryError           | MemoryError                                                  | high         | 功能准备中...  |
| DockerHung            | Task blocked more then beyond the threshold                  | high         | 功能准备中...  |
| KubeletRestart        | Kubelet restart                                              | low          | 功能准备中...  |
| 更多检测项敬请期待    |                                                              |              |                |

## 为节点开启故障自愈功能
### 通过控制台操作
1、 创建故障自愈规则；
![](https://qcloudimg.tencent-cloud.cn/raw/9579afdec6e0bed747ffba29d2615efa.png)
2、 在节点池“详情”页的“运维信息”模块，为节点池开启故障自愈能力；
![](https://qcloudimg.tencent-cloud.cn/raw/c708f966dc3391114344db59a30f572a.png)
3、 在“运维记录”中查看实时故障检测详情，状态为“失败”则代表该检测项未通过；
![](https://qcloudimg.tencent-cloud.cn/raw/5ebacb3fd82671054d7d79c8e3020379.png)

### 通过YAML操作
1、根据命令`kubectl ceate -f demo-HealthCheckPolicy.yaml`集群中创建自愈规则，YAML配置如下；
```
apiVersion: config.tke.cloud.tencent.com/v1
kind: HealthCheckPolicy
metadata:
  name: test-all
  namespace: cls-xxxxxxxx(集群id)
spec:
  machineSetSelector:
    matchLabels:
      key: fake-label
  rules:
  - action: RestartKubelet
    enabled: true
    name: FDPressure
  - action: RestartKubelet
    autoRepairEnabled: true
    enabled: true
    name: RuntimeUnhealthy
  - action: RestartKubelet
    autoRepairEnabled: true
    enabled: true
    name: KubeletUnhealthy
  - action: RestartKubelet
    enabled: true
    name: ReadonlyFilesystem
  - action: RestartKubelet
    enabled: true
    name: OOMKilling
  - action: RestartKubelet
    enabled: true
    name: TaskHung
  - action: RestartKubelet
    enabled: true
    name: UnregisterNetDevice
  - action: RestartKubelet
    enabled: true
    name: KernelOopsDivideError
  - action: RestartKubelet
    enabled: true
    name: KernelOopsNULLPointer
  - action: RestartKubelet
    enabled: true
    name: Ext4Error
  - action: RestartKubelet
    enabled: true
    name: Ext4Warning
  - action: RestartKubelet
    enabled: true
    name: IOError
  - action: RestartKubelet
    enabled: true
    name: MemoryError
  - action: RestartKubelet
    enabled: true
    name: DockerHung
  - action: RestartKubelet
    enabled: true
    name: KubeletRestart

```

2、开启自愈开关
在 MachineSet 中指定字段 `healthCheckPolicyName: test-all`;

```
apiVersion: node.tke.cloud.tencent.com/v1beta1
kind: MachineSet
spec:
  type: Hosted
  displayName: demo-machineset
  replicas: 2
  autoRepair: true
  deletePolicy: Random
  healthCheckPolicyName: test-all
  instanceTypes:
  - C3.LARGE8
  subnetIDs:
  - subnet-xxxxxxxx
  - subnet-yyyyyyyy
......

```



