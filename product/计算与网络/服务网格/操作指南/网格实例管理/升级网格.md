## 操作场景
TCM 提供网格升级服务， 用户可将低版本的网格升级到高版本。升级过程遵循灰度升级原则，分为以下几步：
1. TCM 部署新版本控制面，完成控制面升级。
2. 数据面灰度升级，用户重启业务，使存量业务 Pod 完成 Sidecar 更新。
3. 升级验证，验证升级后业务是否正常。
4. 老版本控制面下线，升级完成。

在老控制面下线前，可以回滚到升级前的状态。整个升级流程，如下图所示：
![升级流程](https://main.qcloudimg.com/raw/c31f033b73c16807336ca7261423ba40.svg)


## 操作步骤
1. 登录 [服务网格控制台](https://console.cloud.tencent.com/tke2/mesh)。
   
2. 当网格版本可升级时，网格界面将会提示有可升级的新版本，如下图所示：
![](https://qcloudimg.tencent-cloud.cn/raw/5d206f5ddf790295d93a5a6fb877df1f.png)

3. 单击**更多-升级**后，将进入升级引导界面：
   升级将按照控制面升级，数据面升级，老控制面下线三个阶段进行，在老控制面下线前，可以回滚到升级前的状态。
![](https://qcloudimg.tencent-cloud.cn/raw/9a0c36c32471a92e59d9968ef739f3ed.png)

4. **控制面升级**，TCM 将部署新版本控制面组件：
![](https://qcloudimg.tencent-cloud.cn/raw/c1070f2d14c91d0c6f02ee47cbba940a.png)

5. **数据面升级**，用户将指定 Namespace 的 Sidecar 自动注入改为使用新版本，开启后，该 Namespace 下**新创建**的业务 Pod 将注入新版本的 Sidecar ，**存量的业务 Pod 重建后才会更新为新版本**，由于重启涉及到业务可用性影响，平台不会自动重建业务 Pod ,**需要用户手动重建**。
  > * 您可以通过流水线重新发布业务或直接使用 kubectl patch、kubectl rollout restart 等命令行工具手工重建工作负载。
  > * 部分场景下 Sidecar 将被卸载而不是升级，例如：Namespace 曾开启过 Sidecar 注入，并且部分业务 Pod 已成功注入 Sidecar，之后又关闭了 Namepsace 级 Sidecar 注入，则重启业务 Pod 后，除非为 Pod 单独设置了 Sidecar 注入标记，否则 Sidecar 将被卸载。
![](https://qcloudimg.tencent-cloud.cn/raw/a6c892d05f9a08d1b437b724524f9616.png)

6. **升级验证**，由于版本升级涉及到特性变更，可能存在兼容性问题，业务 Pod 重建后，你需要检查业务是否正常。如果发现升级导致业务异常，您可以在升级界面中选择回滚，将数据面 Sidecar 退回到原版本。

7. **完成或取消升级**，点击【升级】或【回滚】将检查当前存量Pod是否满足进入下一步的条件。当所有的 Namespace 均切换到新版本控制面，并且所有存量业务 Pod 中 Sidecar 均已更新到新版本后，可以选择点击【升级】，进入下一步下线老版本控制面完成升级。或当所有的 Namespace 均切换回老版本控制面，并且所有存量业务 Pod 中 Sidecar 均使用老版本控制面时，可以点击【回滚】进入下一步将新版本控制面下线，取消升级。
   ![](https://qcloudimg.tencent-cloud.cn/raw/5ac5923e29336ad01604eca4acd52b7c.png)
